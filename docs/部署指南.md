# LinkFox AI设计平台 - 部署指南

## 开发环境部署

### 1. 环境准备

#### 安装Java 11
```bash
# macOS
brew install openjdk@11

# Ubuntu
sudo apt install openjdk-11-jdk

# Windows
# 从Oracle官网下载并安装
```

#### 安装MySQL 8.0
```bash
# macOS
brew install mysql@8.0
brew services start mysql@8.0

# Ubuntu
sudo apt install mysql-server-8.0

# 设置root密码
mysql_secure_installation
```

#### 安装Redis (可选)
```bash
# macOS
brew install redis
brew services start redis

# Ubuntu
sudo apt install redis-server
```

#### 安装Node.js 16+
```bash
# macOS
brew install node@16

# Ubuntu
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt install -y nodejs

# 验证安装
node -v
npm -v
```

### 2. 数据库初始化

```bash
# 登录MySQL
mysql -u root -p

# 执行数据库脚本
source backend/src/main/resources/sql/schema.sql

# 或者
mysql -u root -p < backend/src/main/resources/sql/schema.sql
```

### 3. 后端部署

```bash
# 进入后端目录
cd backend

# 修改配置文件
vim src/main/resources/application.yml
# 修改数据库连接信息

# 编译打包
mvn clean package -DskipTests

# 运行
java -jar target/linkfox-backend-1.0.0.jar

# 或者使用Maven插件运行
mvn spring-boot:run
```

### 4. 前端部署

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 访问 http://localhost:3000
```

## 生产环境部署

### 1. 后端生产部署

#### 使用Jar包部署
```bash
# 打包
cd backend
mvn clean package -DskipTests

# 上传到服务器
scp target/linkfox-backend-1.0.0.jar user@server:/opt/linkfox/

# 在服务器上运行
nohup java -jar /opt/linkfox/linkfox-backend-1.0.0.jar \
  --spring.profiles.active=prod > /opt/linkfox/logs/app.log 2>&1 &
```

#### 使用Systemd管理
```bash
# 创建服务文件
sudo vim /etc/systemd/system/linkfox-backend.service
```

```ini
[Unit]
Description=LinkFox Backend Service
After=syslog.target network.target

[Service]
User=linkfox
Type=simple
WorkingDirectory=/opt/linkfox
ExecStart=/usr/bin/java -jar /opt/linkfox/linkfox-backend-1.0.0.jar
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
# 启动服务
sudo systemctl daemon-reload
sudo systemctl start linkfox-backend
sudo systemctl enable linkfox-backend

# 查看状态
sudo systemctl status linkfox-backend
```

### 2. 前端生产部署

#### 构建生产版本
```bash
cd frontend
npm run build
```

#### 使用Nginx部署
```bash
# 安装Nginx
sudo apt install nginx

# 配置Nginx
sudo vim /etc/nginx/sites-available/linkfox
```

```nginx
server {
    listen 80;
    server_name linkfox.com www.linkfox.com;

    root /var/www/linkfox/dist;
    index index.html;

    # Gzip压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # API代理
    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}
```

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/linkfox /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

#### 配置HTTPS (使用Let's Encrypt)
```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d linkfox.com -d www.linkfox.com

# 自动续期
sudo certbot renew --dry-run
```

### 3. Docker部署

#### 后端Dockerfile
```dockerfile
# backend/Dockerfile
FROM openjdk:11-jre-slim
WORKDIR /app
COPY target/linkfox-backend-1.0.0.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

#### 前端Dockerfile
```dockerfile
# frontend/Dockerfile
FROM node:16 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### Docker Compose
```yaml
# docker-compose.yml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: your_password
      MYSQL_DATABASE: linkfox_db
    volumes:
      - mysql_data:/var/lib/mysql
      - ./backend/src/main/resources/sql:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  backend:
    build: ./backend
    depends_on:
      - mysql
      - redis
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/linkfox_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: your_password
      SPRING_REDIS_HOST: redis
    ports:
      - "8080:8080"

  frontend:
    build: ./frontend
    depends_on:
      - backend
    ports:
      - "80:80"

volumes:
  mysql_data:
```

```bash
# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

## 性能优化

### 1. 后端优化
- 启用JVM参数优化
  ```bash
  java -Xms512m -Xmx2g -XX:+UseG1GC -jar app.jar
  ```
- 配置数据库连接池
- 使用Redis缓存热点数据
- 开启Gzip压缩

### 2. 前端优化
- 代码分割和懒加载
- 静态资源CDN加速
- 图片压缩和WebP格式
- 启用浏览器缓存

### 3. 数据库优化
- 创建合适的索引
- 定期清理过期数据
- 配置主从复制
- 使用读写分离

## 监控和日志

### 1. 后端日志
```bash
# 查看实时日志
tail -f /opt/linkfox/logs/app.log

# 使用ELK进行日志分析
# Elasticsearch + Logstash + Kibana
```

### 2. Nginx日志
```bash
# 访问日志
tail -f /var/log/nginx/access.log

# 错误日志
tail -f /var/log/nginx/error.log
```

### 3. 监控工具
- **Prometheus + Grafana** - 系统监控
- **Spring Boot Actuator** - 应用监控
- **MySQL慢查询日志** - 数据库性能监控

## 备份策略

### 1. 数据库备份
```bash
# 每日备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d)
mysqldump -u root -p linkfox_db > /backup/linkfox_db_$DATE.sql

# 保留最近7天的备份
find /backup -name "linkfox_db_*.sql" -mtime +7 -delete
```

### 2. 文件备份
```bash
# 备份上传的文件
rsync -avz /data/uploads/ /backup/uploads/
```

## 故障排查

### 1. 后端无法启动
- 检查Java版本
- 检查数据库连接
- 查看日志文件
- 检查端口占用

### 2. 前端无法访问
- 检查Nginx配置
- 检查防火墙设置
- 查看Nginx错误日志

### 3. 数据库连接失败
- 检查MySQL服务状态
- 验证用户名密码
- 检查防火墙规则

## 安全建议

1. 使用强密码
2. 定期更新依赖包
3. 配置HTTPS
4. 限制API访问频率
5. 定期备份数据
6. 使用防火墙
7. 监控异常访问

---

如有问题，请查看详细日志或联系技术支持。

